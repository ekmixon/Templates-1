{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "myLabName":{
            "type":"string",
            "defaultValue": "SecurityLab",
            "metadata":{
                "description": "Must be lower-case letters only because it's used in the storage account name"
            }
        },
        "location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]"
        },
        "domainName":{
            "type":"string",
            "defaultValue":"chiefslab.local",
            "metadata":{
                "description": "FQDN of your domain name e.g. mydomain.com"   
            }
        },
        "filePath":{
            "type":"string",
            "defaultValue":"https://raw.githubusercontent.com/signalwarrant/ARM-Templates/main/ADForest/",
            "metadata":{
                "description": "Path in your storage account where the DSC resources are located."
            }
        },
        "dnsIP":{
            "type":"string",
            "defaultValue": "10.0.0.4",
            "metadata":{
                "description": "The first usable IP address DHCP will assign to your DC, .4 of whatever subnet you listed below"   
            }
        },
        "dcName": {
            "type":"string",
            "defaultValue": "DC1",
            "metadata":{
                "description": "The hostname of the Domain Controller"   
            }
        },
        "dcSize": {
            "type": "string",
            "defaultValue":"Standard_B2s",
            "allowedValues":[
                "Standard_B2s"
            ],
            "metadata":{
                "description": "The size of the Domain Controller"   
            }
        },
        "dcSKU": {
            "type": "string",
            "defaultValue": "2019-Datacenter",
            "allowedValues": [
                "2012-R2-Datacenter-smalldisk",
                "2016-Datacenter-smalldisk",
                "2019-Datacenter"
            ],
            "metadata": {
                "description": "Operating System of the Domain Controller"
            }
        },
        "svr19Count":{
            "type":"int",
            "defaultValue": 1,
            "metadata":{
                "description": "Number of Windows Server 2019 VMs to deploy"
            }
        },
        "svr19Prefix":{
            "type":"string",
            "defaultValue":"2019SVR",
            "metadata":{
                "description":"Naming Prefix used for the Windows Server 2019 VMs."
            }
        },
        "svr2019Size": {
            "type": "string",
            "defaultValue":"Standard_B2s",
            "allowedValues":[
                "Standard_B2s"
            ],
            "metadata":{
                "description": "The size of the Windows Server 2019 VMs"   
            }
        },
        "svr2019OSDiskType": {
            "type": "string",
            "defaultValue":"Standard_LRS",
            "allowedValues":[
                "Premium_LRS",
                "Standard_LRS"
            ],
            "metadata": {
                "description": "Disk type for each Windows Server 2019 VM"
            }
        },
        "WIN10Count":{
            "type":"int",
            "defaultValue": 1,
            "metadata":{
                "description": "Number of Windows 10 VMs to deploy"
            }
        },
        "WIN10Prefix":{
            "type":"string",
            "defaultValue":"WIN10CL",
            "metadata":{
                "description":"Naming Prefix used for the Windows 10 VMs."
            }
        },
        "WIN10Size": {
            "type": "string",
            "defaultValue":"Standard_B2s",
            "allowedValues":[
                "Standard_B2s"
            ],
            "metadata":{
                "description": "The size of the Windows 10 VMs"   
            }
        },
        "WIN10OSDiskType": {
            "type": "string",
            "defaultValue":"Standard_LRS",
            "allowedValues":[
                "Premium_LRS",
                "Standard_LRS"
            ],
            "metadata": {
                "description": "Disk type for each  Windows 10 VM"
            }
        },
        "adminUsername": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Admin user for all VMs"
            }
        },
        "adminPassword": {
            "type": "securestring",
            "defaultValue": "",
            "metadata": {
                "description": "Admin Password for all users"
            }
        },
        "addressPrefixes": {
            "type": "array",
            "defaultValue":[
                "10.0.0.0/16"
            ],
            "metadata": {
                "description": "The local IP address space you want to use for the LAB"
            }
        },
        "subnets": {
            "type": "array",
            "defaultValue":[
                {
                    "name": "Domain",
                    "properties": {
                        "addressPrefix": "10.0.0.0/24"
                    }
                },
                {
                    "name": "AzureBastionSubnet",
                    "properties": {
                        "addressPrefix": "10.0.1.0/24"
                    }
                }
            ],
            "metadata": {
                "description": "2 Subnets by default (1 for the domain and 1 for the bastion host) but more are possible"
            }
        },
        "osDiskType": {
            "type": "string",
            "defaultValue":"Standard_LRS",
            "allowedValues":[
                "Premium_LRS",
                "Standard_LRS"
            ],
            "metadata": {
                "description": "Disk type for each VM"
            }
        },
        "bastionHostname": {
            "type": "string",
            "defaultValue": "bHost",
            "metadata": {
                "description": "Bastion Hostname for this vNet"
            }
        },
        "bastion-subnet-ip-prefix": {
            "type": "string",
            "defaultValue": "10.0.1.0/24",
            "metadata": {
                "description": "Bastion subnet IP prefix MUST be within vnet IP prefix address space"
            }
        },
        "azurePlatform":{
            "type":"string",
            "defaultValue":".blob.core.windows.net/",
            "allowedValues":[
                ".blob.core.windows.net/",
                ".blob.core.usgovcloudapi.net/"
            ],
            "metadata":{
                "description": "Storage URI for the version of Azure you're using .blob.core.windows.net/ for Azure Commercial and .blob.core.usgovcloudapi.net/ for Azure Government"
            }
        }
    },
    "variables": {
        "storageAccountName": "[toLower(concat(parameters('myLabName'), 'dsa'))]",
        "storageAccountType": "Standard_LRS",
        "storageAccountKind":"StorageV2",
        "subnetName": "Domain",
        "labvNetName": "[concat(parameters('myLabName'), '-vNET')]",
        "nsgName": "[concat(parameters('myLabName'), '-NSG')]",
        "configFile": "CreateADPDC.zip",
        "configVmScriptFile": "[concat(parameters('filePath'), 'DSC/', variables('configFile'))]",
        "vm1NICName": "[concat(parameters('dcName'), '-NIC')]",
        "vm1PIPName": "[concat(parameters('dcName'), '-PIP')]",
        "TEMPLATES": {
            "SVR2019": {
                "Link": "[concat(parameters('filePath'), 'nestedtemplates/SVR2019.json')]"
            },
            "WIN10": {
                "Link": "[concat(parameters('filePath'), 'nestedtemplates/Win10.json')]"
            },
            "Bastion": {
                "Link": "[concat(parameters('filePath'), 'nestedtemplates/bastion.json')]"
            }
        }
    },
    "resources": [
        {
            "name": "[variables('storageAccountName')]",
            "comments":"The single storage account for the entire Lab. Everything is built referencing this storage account.",
            "type": "Microsoft.Storage/storageAccounts",
            "apiVersion": "2019-06-01",
            "location": "[parameters('location')]",
            "properties": {},
            "kind": "[variables('StorageAccountKind')]",
            "sku": {
                "name": "[variables('storageAccountType')]"
            }
        },
        {
            "name": "[variables('nsgName')]",
            "comments":"The single Network Security group for the entire Lab. All of the VM NICs reference the same NSG, same NSG rules.",
            "type": "Microsoft.Network/networkSecurityGroups",
            "apiVersion": "2019-07-01",
            "location": "[parameters('location')]",
            "properties": {}
        },
        {
            "name": "[variables('labvNetName')]",
            "comments":"The single vNET for the entire LAB.",
            "type": "Microsoft.Network/virtualNetworks",
            "apiVersion": "2019-09-01",
            "location": "[parameters('location')]",
            "properties": {
                "addressSpace": {
                    "addressPrefixes": "[parameters('addressPrefixes')]"
                },
                "subnets": "[parameters('subnets')]"
            }
        },
        {
            "name": "[variables('vm1NICName')]",
            "comments":"The NIC for DC1, the root DC in the forest.",
            "type": "Microsoft.Network/networkInterfaces",
            "apiVersion": "2019-07-01",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups/', variables('nsgName'))]",
                "[resourceId('Microsoft.Network/virtualNetworks/', variables('labvNetName'))]",
                "[resourceId('Microsoft.Network/publicIpAddresses/', variables('vm1PIPName'))]"
            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "ipconfig",
                        "properties": {
                            "subnet": {
                                
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('labvNetName'), variables('subnetName'))]"
                            },
                            "privateIPAllocationMethod": "Dynamic",
                            "publicIpAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIpAddresses', variables('vm1PIPName'))]"
                            }
                        }
                    }
                ],
                "networkSecurityGroup": {
                    "id": "[resourceId('Microsoft.Network/networkSecurityGroups/', variables('nsgName'))]"
                }
            }
        },
        {
            "name": "[variables('vm1PIPName')]",
            "comments":"The Public IP Address for DC1, the root DC in the forest.",
            "type": "Microsoft.Network/publicIpAddresses",
            "apiVersion": "2019-07-01",
            "location": "[parameters('location')]",
            "properties": {
                "publicIpAllocationMethod": "Dynamic"
            },
            "sku": {
                "name": "Basic"
            }
        },
        {
            "name": "[parameters('dcName')]",
            "comments":"Deploying the DC1 VM.",
            "type": "Microsoft.Compute/virtualMachines",
            "apiVersion": "2020-12-01",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkInterfaces/', variables('vm1NICName'))]",
                "[resourceId('Microsoft.Storage/storageAccounts/', variables('storageAccountName'))]"
            ],
            "properties": {
                "hardwareProfile": {
                    "vmSize": "[parameters('dcSize')]"
                },
                "storageProfile": {
                    "osDisk": {
                        "createOption": "fromImage",
                        "name":"[concat(parameters('dcName'), 'sys')]",
                        "managedDisk": {
                            "storageAccountType": "[parameters('osDiskType')]"
                        }
                    },
                    "imageReference": {
                        "publisher": "MicrosoftWindowsServer",
                        "offer": "WindowsServer",
                        "sku": "[parameters('dcSKU')]",
                        "version": "latest"
                    }
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('vm1NICName'))]"
                        }
                    ]
                },
                "osProfile": {
                    "computerName": "[parameters('dcName')]",
                    "adminUsername": "[parameters('adminUsername')]",
                    "adminPassword": "[parameters('adminPassword')]",
                    "windowsConfiguration": {
                        "provisionVMAgent": true,
                        "enableAutomaticUpdates": true,
                        "patchSettings": {
                            "enableHotpatching": false,
                            "patchMode": "AutomaticByPlatform"
                        }
                    }
                },
                "licenseType": "Windows_Server",
                "diagnosticsProfile": {
                    "bootDiagnostics": {
                        "enabled": true,
                        "storageUri": "[concat('https://', variables('storageAccountName'), parameters('azurePlatform'))]"
                    }
                }
            }
        },        
        {
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "comments":"Install Active Directory on DC1.",
            "name": "[concat(parameters('dcName'), '/CreateADPDC')]",
            "apiVersion": "2019-07-01",
            "location": "[parameters('location')]",
            "dependsOn":[
                "[resourceId('Microsoft.Compute/virtualMachines/', parameters('dcName'))]"
            ],
            "properties": {
                "publisher": "Microsoft.Powershell",
                "type": "DSC",
                "typeHandlerVersion": "2.77",
                "autoUpgradeMinorVersion": true,
                "settings": {
                    "wmfVersion": "latest",
                    "modulesUrl": "",
                    "configurationFunction": "",
                    "configuration": {
                        "url": "[variables('configVmScriptFile')]",
                        "script": "CreateADPDC.ps1",
                        "function": "CreateADPDC"
                    },
                    "configurationArguments": {
                        "domainName": "[parameters('domainName')]"
                    } 
                },
                "protectedSettings": {
                    "configurationArguments": {
                        "AdminCreds": {
                            "userName": "[parameters('adminUsername')]",
                            "password": "[parameters('adminPassword')]"
                        }
                    }
                }
            }
        },
        {
            "type":"Microsoft.Resources/deployments",
            "comments":"Update the DNS Server of the Virtual Network with the IP of DC1. Because we've only deployed 1 VM at this point it will always get the .4 local IP address of the subnet you listed in the addressPrefixes parameter above.",
            "apiVersion":"2019-10-01",
            "name":"updateVNet",
            "dependsOn":[
                "[resourceId('Microsoft.Network/virtualNetworks/', variables('labvNetName'))]",
                "[concat('Microsoft.Compute/virtualMachines/', parameters('dcName'), '/extensions/CreateADPDC')]"
            ],
            "properties":{
                "mode":"Incremental",
                "template":{
                    "$schema":"https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion":"1.0.0.0",
                    "resources":[
                        {
                            "name": "[variables('labvNetName')]",
                            "type": "Microsoft.Network/virtualNetworks",
                            "apiVersion": "2019-09-01",
                            "location": "[parameters('location')]",
                            "properties": {
                                "dhcpOptions":{
                                    "dnsServers":[
                                        "[parameters('dnsIP')]"
                                    ]
                                },
                                "addressSpace": {
                                    "addressPrefixes": "[parameters('addressPrefixes')]"
                                },
                                "subnets": "[parameters('subnets')]"
                            }
                        }
                    ]
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "comments":"Deploy Windows Server 2019 VMs if you have chosen to do so.",
            "name": "SVR2019",
            "apiVersion": "2019-07-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                "uri": "[variables('TEMPLATES')['svr2019'].Link]"
                },
                "parameters": {
                    "myLabName":{
                        "value":"[parameters('myLabName')]"
                    },
                    "SVR19Prefix":{
                        "value":"[parameters('SVR19Prefix')]"
                    },
                    "svr19Count":{
                        "value": "[parameters('svr19Count')]"
                    },
                    "svr2019Size": {
                        "value": "[parameters('svr2019Size')]"
                    },
                    "svr2019OSDiskType": {
                        "value": "[parameters('svr2019OSDiskType')]"
                    },
                    "domainName":{
                        "value":"[parameters('domainName')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "azurePlatform": {
                        "value": "[parameters('azurePlatform')]"
                    }
                }
            },
                "dependsOn": [
                    "updateVNet"
                ]
        },
        {
            "type": "Microsoft.Resources/deployments",
            "comments":"Deploy Windows 10 Enterprise VMs if you have chosen to do so.",
            "name": "WIN10",
            "apiVersion": "2019-07-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                "uri": "[variables('TEMPLATES')['Win10'].Link]"
                },
                "parameters": {
                    "myLabName":{
                        "value":"[parameters('myLabName')]"
                    },
                    "WIN10Prefix":{
                        "value":"[parameters('WIN10Prefix')]"
                    },
                    "WIN10Count":{
                        "value": "[parameters('WIN10Count')]"
                    },
                    "WIN10Size": {
                        "value": "[parameters('WIN10Size')]"
                    },
                    "WIN10OSDiskType": {
                        "value": "[parameters('WIN10OSDiskType')]"
                    },
                    "domainName":{
                        "value":"[parameters('domainName')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "azurePlatform": {
                        "value": "[parameters('azurePlatform')]"
                    }
                }
            },
                "dependsOn": [
                    "updateVNet"
                ]
        },
        {
            "type": "Microsoft.Resources/deployments",
            "comments":"Deploy Bastion Host",
            "name": "bastion",
            "apiVersion": "2019-07-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                "uri": "[variables('TEMPLATES')['bastion'].Link]"
                },
                "parameters": {
                    "bastion-vnet-name": {
                        "value": "[variables('labvNetName')]"
                    },
                    "bastion-subnet-ip-prefix": {
                        "value": "[parameters('bastion-subnet-ip-prefix')]"
                    },
                    "bastionHostname": {
                        "value": "[parameters('bastionHostname')]"
                    }
                }
            },
                "dependsOn": [
                    "updateVNet"
                ]
        }
    ],
    "outputs": {
        "adminUsername": {
            "type": "string",
            "value": "[parameters('adminUsername')]"
        }
    }
}